<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ICSA Educational Framework - Interactive Math Learning">
    <meta name="theme-color" content="#1a237e">
    <title>ICSA Educational Framework v3.1 - Enhanced Template</title>
    
    <script>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â­ ICSA FRAMEWORK - ENHANCED UNIVERSAL TEMPLATE v3.1 â­
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           
           ğŸ†• New features in v3.1:
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           âœ… 1. Step Highlighting with Â«Â» markers
           âœ… 2. Fixed Reset button functionality
           âœ… 3. Reset All button to clear all progress
           âœ… 4. Support for visual field
           âœ… 5. Using class instead of inline style
           
           ğŸ†• Features from v3:
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           âœ… 1. Full Gamification System (Points, Badges, Leaderboard)
           âœ… 2. Fixed Progress Bar
           âœ… 3. Variable Color-Coding
           âœ… 4. Progress Saving (localStorage)
           âœ… 5. Understanding Check System
           âœ… 6. Student Profile
           âœ… 7. Analytics Report
           âœ… 8. Timer
           âœ… 9. Dark Mode
           âœ… 10. Enhanced Accessibility
           âœ… 11. Loading States
           âœ… 12. Error Handling
           
           ğŸ“š Scientific References:
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           - Mayer, R. E. (2014). Multimedia Learning
           - Clark & Mayer (2016). e-Learning and the Science of Instruction
           - Meylani (2025). Gamification in Mathematics Education
           - Thomas et al. (2024). Color-coding in Learning
           
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ« SCHOOL BRANDING CONFIGURATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           
           ğŸ“Œ HOW THIS TEMPLATE WORKS:
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           This branded card appears at the top and/or bottom of each lesson.
           When you purchase this template, ALL placeholder values below will be
           replaced with YOUR school's actual information:
           
           âœ… Your school name and logo
           âœ… Your contact information
           âœ… Your programs and curriculum
           âœ… Your location and website
           
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ›’ TO PURCHASE / CUSTOMIZE THIS TEMPLATE:
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           
           Contact: Mohammed Al-Nashshar
           ğŸ“± Phone/WhatsApp: 0506059246
           ğŸ“ Location: Abu Dhabi, UAE
           ğŸ’¼ Experience: 26+ Years in Education & EdTech
           
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const SCHOOL_CONFIG = {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ›’ DEVELOPER/SELLER CONTACT INFO (Visible in demo version)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            isDemoVersion: true,  // Set to false after customization
            
            developer: {
                name: "Mohammed Al-Nashshar",
                title: "EdTech Developer & Educational Consultant",
                phone: "0506059246",
                whatsapp: "0506059246",
                location: "Abu Dhabi, UAE",
                experience: "26+ Years Experience"
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ« SCHOOL PLACEHOLDERS (Will be replaced with your school's info)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            name: "[ Your School Name ]",
            slogan: "[ Your School Slogan ]",
            phone: "[ Your School Phone ]",
            email: "[ info@yourschool.edu ]",
            established: "[ Est. Year ]",
            location: "[ City, Country ]",
            website: "[ www.yourschool.edu ]",
            
            // ğŸ–¼ï¸ Logo placeholder
            logo: "",  // Will be replaced with your school's logo
            
            // ğŸ“š Programs (Will be customized to your curriculum)
            programs: [
                { icon: "ğŸ“", title: "Mathematics", description: "Grades 1-12", details: "Full curriculum coverage" },
                { icon: "ğŸ”¬", title: "Sciences", description: "All branches", details: "Physics, Chemistry, Biology" },
                { icon: "ğŸ’»", title: "Technology", description: "21st Century Skills", details: "Coding, Digital Literacy" },
                { icon: "ğŸŒ", title: "Languages", description: "Multilingual", details: "As per your curriculum" }
            ],
            
            // âœ¨ Features (Will highlight YOUR school's strengths)
            features: [
                "âœ¨ Interactive Digital Lessons",
                "ğŸ¯ Step-by-Step Learning", 
                "ğŸ“Š Student Progress Analytics",
                "ğŸ† Gamified Achievement System"
            ],
            
            // ğŸ¨ Display Settings
            showCard: true,
            cardPosition: "both"  // "top", "bottom", or "both"
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”Š SOUND CONFIGURATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const SOUND_CONFIG = {
            enabled: true,
            volume: 0.3,
            sounds: {
                click: { enabled: true, frequency: 800, duration: 0.05, type: 'sine' },
                stepComplete: { enabled: true, frequency: 600, duration: 0.1, type: 'sine' },
                success: { enabled: true, frequencies: [523, 659, 784], duration: 0.15, type: 'sine' },
                reset: { enabled: true, frequency: 300, duration: 0.1, type: 'triangle' },
                badge: { enabled: true, frequencies: [440, 554, 659, 880], duration: 0.2, type: 'sine' },
                points: { enabled: true, frequency: 1000, duration: 0.08, type: 'sine' }
            },
            showToggleButton: true
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ® GAMIFICATION CONFIGURATION - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const GAMIFICATION_CONFIG = {
            enabled: true,
            
            points: {
                enabled: true,
                display: true,
                values: {
                    viewStep: 5,
                    completeStep: 10,
                    completeProblem: 50,
                    firstTryBonus: 20,
                    speedBonus: 15,
                    perfectScore: 100,
                    understandingHigh: 15,
                    understandingMedium: 5
                },
                storage: 'localStorage'
            },
            
            badges: {
                enabled: true,
                list: [
                    { id: "starter", emoji: "ğŸŒŸ", name: "Golden Start", condition: "complete_first_step", points: 10 },
                    { id: "problem_solver", emoji: "ğŸ§©", name: "Problem Solver", condition: "complete_first_problem", points: 50 },
                    { id: "fast_learner", emoji: "âš¡", name: "Fast Learner", condition: "complete_under_2min", points: 30 },
                    { id: "persistent", emoji: "ğŸ’ª", name: "Persistent", condition: "complete_3_problems", points: 100 },
                    { id: "understanding", emoji: "ğŸ§ ", name: "Deep Understander", condition: "all_high_understanding", points: 75 },
                    { id: "master", emoji: "ğŸ†", name: "Master", condition: "complete_all", points: 200 },
                    { id: "perfect", emoji: "ğŸ’", name: "Perfectionist", condition: "all_first_try", points: 300 }
                ]
            },
            
            progressBar: {
                enabled: true,
                position: "top-fixed",
                style: "gradient",
                showPercentage: true,
                showSteps: true,
                colors: { start: "#667eea", end: "#764ba2" }
            },
            
            celebrations: {
                confetti: true,
                sound: true,
                vibration: false,
                messages: {
                    step: ["Well done! ğŸ‘", "Excellent! ğŸŒŸ", "Keep going! ğŸ’ª", "Great! ğŸ¯"],
                    problem: ["Awesome! Problem completed! ğŸ‰", "Great work! ğŸ†", "Amazing progress! ğŸš€"],
                    complete: ["Congratulations! You completed the entire lesson! ğŸŠğŸ†ğŸŒŸ"]
                }
            },
            
            timer: {
                enabled: true,
                showPerProblem: true,
                showTotal: true,
                speedBonusThreshold: 120 // seconds
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¨ VARIABLE COLOR-CODING - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const VARIABLE_COLORS = {
            enabled: true,
            scheme: {
                x: { color: '#2196F3', bg: 'rgba(33, 150, 243, 0.1)' },
                y: { color: '#4CAF50', bg: 'rgba(76, 175, 80, 0.1)' },
                z: { color: '#9C27B0', bg: 'rgba(156, 39, 176, 0.1)' },
                a: { color: '#E91E63', bg: 'rgba(233, 30, 99, 0.1)' },
                b: { color: '#00BCD4', bg: 'rgba(0, 188, 212, 0.1)' },
                c: { color: '#FF5722', bg: 'rgba(255, 87, 34, 0.1)' },
                i: { color: '#FF9800', bg: 'rgba(255, 152, 0, 0.1)' },
                n: { color: '#795548', bg: 'rgba(121, 85, 72, 0.1)' },
                m: { color: '#607D8B', bg: 'rgba(96, 125, 139, 0.1)' }
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           âœ… UNDERSTANDING CHECK CONFIGURATION - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const UNDERSTANDING_CONFIG = {
            enabled: true,
            frequency: "after_each_problem",
            showAfterSteps: false,
            
            options: [
                { value: 5, emoji: "ğŸ˜Š", label: "Fully understood", color: "#4CAF50" },
                { value: 4, emoji: "ğŸ™‚", label: "Mostly understood", color: "#8BC34A" },
                { value: 3, emoji: "ğŸ˜", label: "Partially understood", color: "#FFC107" },
                { value: 2, emoji: "ğŸ˜•", label: "Need review", color: "#FF9800" },
                { value: 1, emoji: "ğŸ˜Ÿ", label: "Did not understand", color: "#f44336" }
            ],
            
            showHint: true,
            allowRepeat: true
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ‘¤ STUDENT PROFILE CONFIGURATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const STUDENT_PROFILE_CONFIG = {
            enabled: true,
            collectOnStart: true,
            saveProgress: true,
            
            fields: {
                name: { required: false, label: "Name" },
                gradeLevel: { 
                    required: false, 
                    label: "Grade",
                    options: ["Grade 3", "Grade 4", "Grade 5", "Grade 6", "Grade 7", "Grade 8", "Grade 9", "Grade 10", "Grade 11", "Grade 12"]
                }
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“Š ANALYTICS CONFIGURATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const ANALYTICS_CONFIG = {
            enabled: true,
            trackingLevel: "detailed",
            
            metrics: {
                timeSpent: { total: 0, perStep: [], perProblem: [] },
                performance: { stepsCompleted: 0, problemsCompleted: 0, hintsUsed: 0, retries: 0, understandingScores: [] },
                engagement: { clicksPerMinute: 0, scrollDepth: 0, focusTime: 0 }
            },
            
            export: { formats: ["json"], includeTimestamp: true }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“š LESSON CONFIGURATION (Loaded from JSON)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const LESSON_CONFIG = {"institution":{"name":"ICSA Framework Demo","location":"Abu Dhabi, UAE","logo":""},"lesson":{"grade":"Grades 4-12","subject":"Mathematics","topic":"Complete Math Journey","subtopic":"From Basic Arithmetic to Calculus","part":"Marketing Showcase","language":"en","duration":"20-30 minutes"},"methodIntro":{"title":"ğŸš€ Experience Mathematics Like Never Before!","explanation":{"title":"Why ICSA Framework?","description":"Interactive system with golden highlights, visual aids, coordinate graphs, and gamified achievements. Covers Grades 4-12.","formula":{"standard":"Success = Understanding Ã— Engagement Ã— Practice","where":"Every step designed for maximum comprehension"}},"keyPoints":[{"title":"ğŸ¯ Multi-Level","content":"Grades 4-12 in one framework"},{"title":"âœ¨ Visual Learning","content":"Golden highlights + graphs"},{"title":"ğŸ† Gamification","content":"Points, badges, achievements"}]},"problems":[{"id":1,"label":"Problem 1 of 6 - Grade 4: Basic Addition ğŸŸ¢","equation":"25 + 17 = ?","difficulty":"easy","method":"Place Value Decomposition","targetTime":60,"steps":[{"number":1,"level":"easy","title":"Break down 17 into tens and ones","content":{"formula":"25 + Â«17Â» = 25 + Â«10 + 7Â»","visual":"ğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µ (25) + ğŸŸ¢Ã—10 + ğŸŸ¡Ã—7","hint":"Breaking numbers makes addition easier!"}},{"number":2,"level":"easy","title":"Add the tens first","content":{"formula":"Â«25 + 10Â» = Â«35Â»","visual":"Adding 10 just changes the tens digit"}},{"number":3,"level":"critical","title":"Add the ones","content":{"formula":"Â«35 + 7Â» = Â«42Â»","visual":"ğŸ¯ Final Answer: 42"}}],"finalAnswer":"42","practice":"Try: 38 + 24 = ?"},{"id":2,"label":"Problem 2 of 6 - Grade 6: Fractions ğŸŸ¡","equation":"Â½ + â…“ = ?","difficulty":"medium","method":"Finding Common Denominators","targetTime":90,"steps":[{"number":1,"level":"easy","title":"Find the LCD","content":{"formula":"LCD of 2 and 3 = Â«6Â»","visual":"ğŸ• Cut pizza into 6 equal slices","hint":"6 is divisible by both 2 and 3"}},{"number":2,"level":"medium","title":"Convert both fractions","content":{"formulas":["Â½ = Â«3/6Â»","â…“ = Â«2/6Â»"],"visual":"ğŸ•ğŸ•ğŸ• + ğŸ•ğŸ• = 5 slices out of 6"}},{"number":3,"level":"critical","title":"Add the numerators","content":{"formula":"Â«3/6 + 2/6Â» = Â«5/6Â»","visual":"ğŸ•ğŸ•ğŸ•ğŸ•ğŸ• = 5/6 of the pizza!"}}],"finalAnswer":"5/6","practice":"Try: Â¼ + Â½ = ?"},{"id":3,"label":"Problem 3 of 6 - Grade 8: Linear Equation ğŸ“ˆ","equation":"2x + 5 = 13","difficulty":"medium","method":"Algebraic Solving with Graph","targetTime":120,"steps":[{"number":1,"level":"easy","title":"Subtract 5 from both sides","content":{"formula":"2x + 5 Â«- 5Â» = 13 Â«- 5Â»","visual":"âš–ï¸ Keep the balance!","hint":"What you do to one side, do to the other"}},{"number":2,"level":"medium","title":"Simplify","content":{"formula":"2x = Â«8Â»","visual":"ğŸ“Š On graph y=2x+5: find where y=13"}},{"number":3,"level":"critical","title":"Divide by 2","content":{"formula":"x = Â«8 Ã· 2Â» = Â«4Â»","visual":"ğŸ“ Point (4, 13) on the line","hint":"Verify: 2(4) + 5 = 13 âœ“"}}],"finalAnswer":"x = 4","practice":"Solve: 3x - 7 = 14"},{"id":4,"label":"Problem 4 of 6 - Grade 10: Quadratic Formula ğŸ”´","equation":"xÂ² - 5x + 6 = 0","difficulty":"hard","method":"Quadratic Formula: x = (-b Â± âˆšÎ”) / 2a","targetTime":180,"steps":[{"number":1,"level":"easy","title":"Identify a, b, c","content":{"formula":"a = Â«1Â», b = Â«-5Â», c = Â«6Â»","visual":"ğŸ“ axÂ² + bx + c = 0"}},{"number":2,"level":"medium","title":"Calculate Î” (Discriminant)","content":{"formula":"Î” = bÂ² - 4ac = Â«(-5)Â² - 4(1)(6)Â» = Â«25 - 24Â» = Â«1Â»","visual":"ğŸ” Î” > 0 â†’ Two real roots","hint":"Î” determines nature of roots"}},{"number":3,"level":"medium","title":"Apply the formula","content":{"formula":"x = Â«(5 Â± âˆš1) / 2Â» = Â«(5 Â± 1) / 2Â»","warning":"Don't forget Â± gives TWO solutions!"}},{"number":4,"level":"critical","title":"Find both roots","content":{"formulas":["xâ‚ = (5 + 1) / 2 = Â«3Â»","xâ‚‚ = (5 - 1) / 2 = Â«2Â»"],"visual":"ğŸ“ˆ Parabola crosses x-axis at 2 and 3"}}],"finalAnswer":"x = 2 or x = 3","practice":"Solve: xÂ² - 7x + 12 = 0"},{"id":5,"label":"Problem 5 of 6 - Grade 12: Differentiation ğŸ”´","equation":"d/dx(xÂ³ + 2xÂ² - 5x + 3)","difficulty":"hard","method":"Power Rule: d/dx(xâ¿) = nÂ·xâ¿â»Â¹","targetTime":150,"steps":[{"number":1,"level":"easy","title":"Recall the Power Rule","content":{"formula":"d/dx(xâ¿) = Â«n Ã— xâ¿â»Â¹Â»","visual":"ğŸ“š Bring power down, reduce by 1"}},{"number":2,"level":"medium","title":"Differentiate each term","content":{"formulas":["d/dx(xÂ³) = Â«3xÂ²Â»","d/dx(2xÂ²) = Â«4xÂ»","d/dx(-5x) = Â«-5Â»","d/dx(3) = Â«0Â»"],"visual":"ğŸ“ Constants â†’ 0"}},{"number":3,"level":"critical","title":"Combine results","content":{"formula":"f'(x) = Â«3xÂ² + 4x - 5Â»","visual":"ğŸ“ˆ Derivative = slope at any point"}}],"finalAnswer":"f'(x) = 3xÂ² + 4x - 5","practice":"Find f'(x) for f(x) = xâ´ - 3xÂ² + 2x"},{"id":6,"label":"Problem 6 of 6 - Grade 12: Integration ğŸ”´","equation":"âˆ«(6xÂ² + 4x - 3)dx","difficulty":"hard","method":"Power Rule: âˆ«xâ¿dx = xâ¿âºÂ¹/(n+1) + C","targetTime":150,"steps":[{"number":1,"level":"easy","title":"Recall Integration Rule","content":{"formula":"âˆ«xâ¿ dx = Â«xâ¿âºÂ¹/(n+1)Â» + C","visual":"ğŸ“š Add 1 to power, divide by new power"}},{"number":2,"level":"medium","title":"Integrate each term","content":{"formulas":["âˆ«6xÂ² dx = Â«2xÂ³Â»","âˆ«4x dx = Â«2xÂ²Â»","âˆ«-3 dx = Â«-3xÂ»"],"warning":"Always add + C for indefinite integrals!"}},{"number":3,"level":"critical","title":"Combine and add C","content":{"formula":"= Â«2xÂ³ + 2xÂ² - 3x + CÂ»","visual":"âœ… Verify: d/dx(answer) = 6xÂ² + 4x - 3 âœ“"}}],"finalAnswer":"2xÂ³ + 2xÂ² - 3x + C","practice":"Evaluate: âˆ«â‚€Â²(6xÂ² + 4x - 3)dx"}],"text":{"welcome":{"title":"ğŸš€ ICSA Framework Demo","description":"Experience math from Grade 4 to Grade 12!"},"progress":{"title":"ğŸ“Š Your Journey","description":"Complete all 6 problems to unlock Master badge! ğŸ†"},"completion":{"title":"ğŸ‰ Congratulations!","message":"You've experienced ICSA Framework!","nextSteps":"ğŸ“± Contact: 0506059246 | WhatsApp Available"},"buttons":{"nextStep":"Next Step â†’","showAll":"Show All","reset":"Reset","tryThis":"ğŸ¯ Try This!"}},"settings":{"animation":{"stepDelay":150,"scrollBehavior":"smooth"},"confetti":{"enabled":true,"particleCount":80}}};
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸµ SOUND MANAGER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const SoundManager = {
            audioContext: null,
            isEnabled: true,
            
            init() {
                if (!SOUND_CONFIG.enabled) return;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.isEnabled = SOUND_CONFIG.enabled;
                } catch (e) {
                    console.log('Web Audio API not supported');
                    this.isEnabled = false;
                }
            },
            
            playTone(frequency, duration, type = 'sine') {
                if (!this.isEnabled || !this.audioContext) return;
                if (this.audioContext.state === 'suspended') this.audioContext.resume();
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(SOUND_CONFIG.volume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            },
            
            playClick() { const s = SOUND_CONFIG.sounds.click; if (s.enabled) this.playTone(s.frequency, s.duration, s.type); },
            playStepComplete() { const s = SOUND_CONFIG.sounds.stepComplete; if (s.enabled) this.playTone(s.frequency, s.duration, s.type); },
            playSuccess() { const s = SOUND_CONFIG.sounds.success; if (!s.enabled) return; s.frequencies.forEach((freq, i) => setTimeout(() => this.playTone(freq, s.duration, s.type), i * 100)); },
            playReset() { const s = SOUND_CONFIG.sounds.reset; if (s.enabled) this.playTone(s.frequency, s.duration, s.type); },
            playBadge() { const s = SOUND_CONFIG.sounds.badge; if (!s.enabled) return; s.frequencies.forEach((freq, i) => setTimeout(() => this.playTone(freq, s.duration, s.type), i * 80)); },
            playPoints() { const s = SOUND_CONFIG.sounds.points; if (s.enabled) this.playTone(s.frequency, s.duration, s.type); },
            toggle() { this.isEnabled = !this.isEnabled; return this.isEnabled; }
        };
    </script>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ğŸ¨ CSS - ENHANCED STYLING v3
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Fira+Code:wght@400;500;600&family=Tajawal:wght@400;500;700;800&display=swap');
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¨ CSS VARIABLES - with Dark Mode Support
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        :root {
            /* Colors - Light Mode */
            --primary: #1a237e;
            --primary-light: #3949ab;
            --secondary: #283593;
            --accent: #00bcd4;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a237e;
            --text-secondary: #455a64;
            --text-muted: #78909c;
            
            --border-color: rgba(26, 35, 126, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            
            /* Level Colors */
            --level-easy: #e3f2fd;
            --level-easy-border: #2196F3;
            --level-medium: #e8f5e9;
            --level-medium-border: #4CAF50;
            --level-hard: #fff3e0;
            --level-hard-border: #FF9800;
            --level-critical: #fce4ec;
            --level-critical-border: #E91E63;
            
            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 15px;
            --radius-lg: 25px;
            
            /* Container */
            --container-max-width: min(95vw, 950px);
            
            /* Progress Bar */
            --progress-height: 6px;
            
            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               ğŸ“ RESPONSIVE FONT SIZES - Based on Screen WIDTH (vw)
               Formula: clamp(min, preferred, max)
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            
            /* Base font - scales with screen width */
            --font-base: clamp(14px, 2.5vw, 18px);
            
            /* Headings - responsive to width */
            --font-h1: clamp(1.5rem, 5vw, 2.5rem);
            --font-h2: clamp(1.3rem, 4vw, 2rem);
            --font-h3: clamp(1.1rem, 3.5vw, 1.5rem);
            
            /* Math & Equations - important for readability */
            --font-equation: clamp(1.2rem, 4.5vw, 2rem);
            --font-math: clamp(0.95rem, 3.5vw, 1.4rem);
            --font-formula: clamp(0.9rem, 3vw, 1.2rem);
            
            /* UI Elements */
            --font-button: clamp(0.85rem, 2.5vw, 1rem);
            --font-label: clamp(0.75rem, 2vw, 0.9rem);
            --font-small: clamp(0.7rem, 1.8vw, 0.85rem);
            
            /* Step content */
            --font-step-title: clamp(0.95rem, 3vw, 1.1rem);
            --font-step-content: clamp(0.9rem, 2.8vw, 1.05rem);
            --font-hint: clamp(0.85rem, 2.5vw, 1rem);
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            /* ğŸŒ™ Dark Mode Colors - Enhanced Visibility */
            --primary: #64b5f6;          /* Light blue instead of dark */
            --primary-light: #90caf9;
            --secondary: #81d4fa;        /* Sky blue light */
            --accent: #4dd0e1;
            --success: #81c784;
            --warning: #ffb74d;
            --error: #ef5350;
            
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;   /* Lighter for readability */
            --text-muted: #9e9e9e;       /* Lighter */
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            
            /* Level backgrounds - brighter for dark mode */
            --level-easy: rgba(33, 150, 243, 0.25);
            --level-easy-border: #64b5f6;
            --level-medium: rgba(76, 175, 80, 0.25);
            --level-medium-border: #81c784;
            --level-hard: rgba(255, 152, 0, 0.25);
            --level-hard-border: #ffb74d;
            --level-critical: rgba(233, 30, 99, 0.25);
            --level-critical-border: #f48fb1;
        }
        
        /* ğŸŒ™ Dark Mode Specific Overrides */
        [data-theme="dark"] .step-title,
        [data-theme="dark"] .step-number {
            color: #ffffff;
        }
        
        [data-theme="dark"] .equation {
            color: #90caf9;
        }
        
        [data-theme="dark"] .math-line {
            color: #e0e0e0;
        }
        
        [data-theme="dark"] .hint {
            background: rgba(255, 193, 7, 0.25);
            color: #fff8e1;
        }
        
        [data-theme="dark"] .warning {
            background: rgba(244, 67, 54, 0.2);
            color: #ffcdd2;
        }
        
        [data-theme="dark"] .btn-reset {
            background: #2d2d2d;
            color: #ffffff;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        [data-theme="dark"] .var-colored {
            filter: brightness(1.3);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“ BASE STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            /* ğŸ“ Responsive base font - scales with screen WIDTH */
            font-size: var(--font-base);
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-step-content);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: var(--spacing-md);
            padding-top: calc(var(--progress-height) + var(--spacing-md) + 60px);
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        #app {
            max-width: var(--container-max-width);
            margin: 0 auto;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ” FIXED PROGRESS BAR - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .fixed-progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            z-index: 9999;
            box-shadow: var(--shadow-sm);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.3s ease;
        }
        
        .fixed-progress-bar {
            flex: 1;
            height: var(--progress-height);
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .fixed-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        
        .fixed-progress-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 80px;
            text-align: right;
        }
        
        .fixed-progress-steps {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â­ POINTS & BADGES DISPLAY - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .gamification-panel {
            position: fixed;
            top: 50px;
            right: 20px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 200px;
        }
        
        .points-display {
            background: linear-gradient(135deg, #ffd54f, #ff6f00);
            color: #1a237e;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(255, 111, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: pointsGlow 2s ease-in-out infinite;
        }
        
        @keyframes pointsGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 111, 0, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(255, 111, 0, 0.5); }
        }
        
        .points-display .points-icon { font-size: 1.2rem; }
        .points-display .points-value { font-size: 1.1rem; }
        
        .points-popup {
            position: fixed;
            font-size: 1.5rem;
            font-weight: 700;
            color: #4caf50;
            pointer-events: none;
            z-index: 10001;
            animation: pointsFloat 1s ease-out forwards;
        }
        
        @keyframes pointsFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            justify-content: flex-end;
        }
        
        .badge-item {
            display: none;
            background: var(--bg-card);
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            box-shadow: var(--shadow-sm);
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }
        
        .badge-item.earned {
            display: inline-flex;
            opacity: 1;
            transform: scale(1);
            animation: badgePop 0.5s ease;
        }
        
        @keyframes badgePop {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â±ï¸ TIMER DISPLAY - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .timer-display {
            position: fixed;
            top: 50px;
            left: 20px;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timer-icon { font-size: 1.1rem; }
        .timer-value { font-weight: 600; color: var(--text-primary); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸŒ™ THEME TOGGLE - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .theme-toggle {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
            z-index: 9997;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”Š SOUND TOGGLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
            z-index: 9997;
            transition: all 0.3s ease;
        }
        
        .sound-toggle:hover { transform: scale(1.1); }
        .sound-toggle.muted { background: #9e9e9e; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“„ SECTIONS & CARDS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            text-align: center;
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .subtitle {
            text-align: center;
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }
        
        .info-box {
            background: var(--bg-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            text-align: center;
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .welcome-section, .progress-section, .intro-section, .problem-card, .completion-section {
            background: var(--bg-card);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: background 0.3s ease;
        }
        
        .welcome-section h2, .intro-section h2 {
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-h2);
        }
        
        .progress-section h3 {
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-h3);
        }
        
        /* Color Guide */
        .color-guide {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
        }
        
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .color-dot.blue { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .color-dot.green { background: linear-gradient(135deg, #4CAF50, #388E3C); }
        .color-dot.orange { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .color-dot.pink { background: linear-gradient(135deg, #E91E63, #C2185B); }
        
        /* Progress Bar (inline) */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin-top: var(--spacing-sm);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.5s ease;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“ STEPS & PROBLEMS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .problem-card {
            border-left: 5px solid var(--primary);
        }
        
        .problem-num {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        
        .equation-container {
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-sm) 0;
            text-align: center;
        }
        
        [data-theme="dark"] .equation-container {
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.2), rgba(156, 39, 176, 0.2));
        }
        
        .equation {
            font-family: 'Fira Code', monospace;
            font-size: var(--font-equation);
            color: var(--primary);
            font-weight: 600;
        }
        
        .math-container {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
        }
        
        [data-theme="dark"] .math-container {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.15), rgba(0, 188, 212, 0.15));
        }
        
        .math-line {
            font-family: 'Fira Code', monospace;
            font-size: var(--font-math);
            color: var(--secondary);
            font-weight: 500;
            display: block;
            padding: 0.4rem 0;
            text-align: center;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .math-line:not(:last-child) {
            border-bottom: 1px dashed var(--border-color);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¨ HIGHLIGHT STYLES - Step Highlighting v3.1
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .highlight-step {
            background: linear-gradient(120deg, #FFD700 0%, #FFA500 100%);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
            color: #1a1a1a;
            box-shadow: 0 2px 4px rgba(255,165,0,0.3);
            margin: 0 2px;
            display: inline-block;
            animation: highlightPulse 2s ease-in-out infinite;
        }
        
        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 2px 4px rgba(255,165,0,0.3); }
            50% { box-shadow: 0 4px 12px rgba(255,165,0,0.5); }
        }
        
        [data-theme="dark"] .highlight-step {
            background: linear-gradient(120deg, #FFA500 0%, #FF8C00 100%);
            color: #000;
        }
        
        .visual-aid {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-left: 4px solid #4CAF50;
            padding: 0.8rem 1rem;
            border-radius: 0 8px 8px 0;
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }
        
        .visual-aid::before {
            content: "ğŸ‘ï¸ ";
        }
        
        [data-theme="dark"] .visual-aid {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(129, 199, 132, 0.2));
        }
        
        .btn-reset-all {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-reset-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }
        
        /* Variable Color-Coding */
        .var-colored {
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }
        
        .btn {
            font-family: inherit;
            font-size: var(--font-button);
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-step {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }
        
        .btn-all {
            background: linear-gradient(135deg, var(--success), #388E3C);
            color: white;
        }
        
        .btn-reset {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* Steps */
        .step {
            display: none;
            padding: var(--spacing-md);
            margin: var(--spacing-sm) 0;
            border-radius: var(--radius-md);
            border-left: 4px solid;
            animation: fadeIn 0.4s ease;
        }
        
        .step.visible { display: block; }
        
        .step.easy { background: var(--level-easy); border-color: var(--level-easy-border); }
        .step.medium { background: var(--level-medium); border-color: var(--level-medium-border); }
        .step.hard { background: var(--level-hard); border-color: var(--level-hard-border); }
        .step.critical { background: var(--level-critical); border-color: var(--level-critical-border); }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: clamp(24px, 6vw, 30px);
            height: clamp(24px, 6vw, 30px);
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: var(--font-small);
            margin-right: 0.5rem;
        }
        
        .step-title {
            font-weight: 600;
            font-size: var(--font-step-title);
            color: var(--text-primary);
        }
        
        .step-content {
            margin-top: var(--spacing-sm);
            padding-left: clamp(20px, 5vw, 40px);
            font-size: var(--font-step-content);
        }
        
        .hint {
            background: rgba(255, 193, 7, 0.2);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            border-left: 3px solid #FFC107;
            font-size: var(--font-hint);
        }
        
        .warning {
            background: rgba(244, 67, 54, 0.1);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            border-left: 3px solid #f44336;
            color: #c62828;
            font-size: var(--font-hint);
        }
        
        .next-step-btn {
            margin-top: var(--spacing-sm);
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .next-step-btn:hover {
            background: var(--primary-light);
            transform: translateX(5px);
        }
        
        /* Final Answer */
        .final-answer {
            display: none;
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            text-align: center;
            font-size: 1.2rem;
        }
        
        [data-theme="dark"] .final-answer {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(139, 195, 74, 0.2));
        }
        
        .answer-value {
            font-family: 'Fira Code', monospace;
            font-weight: 700;
            color: var(--success);
            font-size: 1.4rem;
        }
        
        /* Practice */
        .practice {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            border: 2px dashed var(--warning);
        }
        
        [data-theme="dark"] .practice {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 193, 7, 0.15));
        }
        
        .practice-title {
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 0.5rem;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           âœ… UNDERSTANDING CHECK - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .understanding-check {
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
            border: 2px solid var(--primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            text-align: center;
        }
        
        [data-theme="dark"] .understanding-check {
            background: linear-gradient(135deg, rgba(63, 81, 181, 0.2), rgba(103, 58, 183, 0.2));
        }
        
        .check-question {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .check-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .check-option {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .check-option:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }
        
        .check-option.selected {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ« SCHOOL/BRANDING CARD
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .teacher-card {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 30%, #00838f 70%, #00695c 100%);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            color: white;
        }
        
        .teacher-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: var(--spacing-lg);
            text-align: center;
        }
        
        .teacher-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd54f, #ff6f00);
            margin: 0 auto var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .teacher-avatar::after { content: 'ğŸ‘¨â€ğŸ«'; }
        
        .teacher-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }
        
        .teacher-title {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .teacher-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .teacher-contact {
            padding: var(--spacing-md);
            text-align: center;
        }
        
        .contact-phone {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.15);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .contact-phone:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.02);
        }
        
        .phone-icon { font-size: 1.5rem; }
        .phone-number { font-size: 1.3rem; font-weight: 700; }
        .phone-label { font-size: 0.8rem; opacity: 0.8; }
        
        .teacher-services {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
        }
        
        .service-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .service-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .service-icon { font-size: 2rem; margin-bottom: 0.3rem; }
        .service-title { font-weight: 600; font-size: 0.95rem; }
        .service-desc { font-size: 0.8rem; opacity: 0.8; }
        .service-details { font-size: 0.7rem; opacity: 0.6; margin-top: 0.3rem; }
        
        .teacher-features {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            padding: var(--spacing-md);
            background: rgba(0, 0, 0, 0.1);
        }
        
        .feature-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
        }
        
        .teacher-footer {
            padding: var(--spacing-md);
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .teacher-cta { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .powered-by { font-size: 0.75rem; opacity: 0.7; }
        .powered-by span { font-weight: 700; color: #ffd54f; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ‰ COMPLETION SECTION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .completion-section {
            text-align: center;
            background: linear-gradient(135deg, #c8e6c9, #81c784);
        }
        
        [data-theme="dark"] .completion-section {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3));
        }
        
        .completion-section h2 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--success);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”„ LOADING STATE - NEW v3
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: var(--spacing-md);
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¬ ANIMATIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“± RESPONSIVE DESIGN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        @media (max-width: 768px) {
            .gamification-panel {
                top: auto;
                bottom: 140px;
                right: 10px;
                left: 10px;
                max-width: none;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .timer-display {
                top: auto;
                bottom: 140px;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .teacher-services {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: var(--spacing-xs);
                padding-top: calc(var(--progress-height) + var(--spacing-xs) + 50px);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .step-content {
                padding-left: 0;
            }
            
            .teacher-services {
                grid-template-columns: 1fr;
            }
            
            .gamification-panel {
                bottom: 130px;
            }
            
            /* ğŸ“ Adjust font variables for small screens */
            :root {
                --font-equation: clamp(1rem, 5vw, 1.5rem);
                --font-math: clamp(0.85rem, 4vw, 1.2rem);
            }
        }
        
        @media (max-width: 320px) {
            /* ğŸ“ Extra small screens - minimum readable sizes */
            :root {
                --font-base: 14px;
                --font-equation: clamp(0.9rem, 5.5vw, 1.3rem);
                --font-math: clamp(0.8rem, 4.5vw, 1.1rem);
                --font-step-title: clamp(0.85rem, 4vw, 1rem);
                --font-step-content: clamp(0.8rem, 3.5vw, 0.95rem);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸŒ RTL (Right-to-Left) Support for Arabic
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        [dir="rtl"] {
            text-align: right;
        }
        
        [dir="rtl"] .step {
            border-left: none;
            border-right: 4px solid;
        }
        
        [dir="rtl"] .step-number {
            margin-right: 0;
            margin-left: 0.5rem;
        }
        
        [dir="rtl"] .step-content {
            padding-left: 0;
            padding-right: clamp(20px, 5vw, 40px);
        }
        
        [dir="rtl"] .hint,
        [dir="rtl"] .warning,
        [dir="rtl"] .visual-aid {
            border-left: none;
            border-right: 3px solid;
        }
        
        [dir="rtl"] .hint { border-right-color: #FFC107; }
        [dir="rtl"] .warning { border-right-color: #f44336; }
        [dir="rtl"] .visual-aid { border-right-color: #4CAF50; }
        
        [dir="rtl"] .rules-box {
            border-left: none;
            border-right: 5px solid var(--primary);
        }
        
        [dir="rtl"] .controls {
            flex-direction: row-reverse;
        }
        
        [dir="rtl"] .btn {
            flex-direction: row-reverse;
        }
        
        [dir="rtl"] .next-step-btn::after {
            content: ' â†';
        }
        
        [dir="rtl"] .next-step-btn::before {
            content: none;
        }
        
        /* Print */
        @media print {
            body { background: white; padding: 0; }
            .btn, .controls, .fixed-progress-container, .gamification-panel, 
            .timer-display, .sound-toggle, .theme-toggle { display: none !important; }
            .teacher-card { break-inside: avoid; }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus States for Accessibility */
        :focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            z-index: 100000;
            transition: top 0.3s ease;
        }
        
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
    
    <!-- Fixed Progress Bar -->
    <div class="fixed-progress-container" id="fixedProgress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="fixed-progress-bar">
            <div class="fixed-progress-fill" id="fixedProgressFill" style="width: 0%"></div>
        </div>
        <div class="fixed-progress-text">
            <span id="fixedProgressPercent">0%</span>
            <span class="fixed-progress-steps" id="fixedProgressSteps">(0/0)</span>
        </div>
    </div>
    
    <!-- Gamification Panel -->
    <div class="gamification-panel" id="gamificationPanel">
        <div class="points-display" id="pointsDisplay" aria-live="polite">
            <span class="points-icon">â­</span>
            <span class="points-value" id="pointsValue">0</span>
        </div>
        <div class="badges-container" id="badgesContainer" aria-label="Earned badges"></div>
    </div>
    
    <!-- Timer Display -->
    <div class="timer-display" id="timerDisplay" aria-live="polite">
        <span class="timer-icon">â±ï¸</span>
        <span class="timer-value" id="timerValue">00:00</span>
    </div>
    
    <!-- Main Content -->
    <main id="main-content">
        <div id="app"></div>
    </main>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ğŸ“œ JAVASCRIPT - RENDERING ENGINE v3
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <script>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ® STATE MANAGEMENT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const AppState = {
            completed: new Set(),
            currentStep: {},
            points: 0,
            earnedBadges: new Set(),
            understandingScores: {},
            startTime: Date.now(),
            problemTimers: {},
            isLoading: true,
            theme: 'light'
        };
        
        // Initialize currentStep for each problem
        LESSON_CONFIG.problems.forEach(p => AppState.currentStep[p.id] = 1);
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ’¾ STORAGE MANAGER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const StorageManager = {
            key: 'icsa_progress_' + LESSON_CONFIG.lesson.topic.replace(/\s+/g, '_'),
            
            save() {
                try {
                    const data = {
                        completed: Array.from(AppState.completed),
                        currentStep: AppState.currentStep,
                        points: AppState.points,
                        earnedBadges: Array.from(AppState.earnedBadges),
                        understandingScores: AppState.understandingScores,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(this.key, JSON.stringify(data));
                } catch (e) {
                    console.warn('Could not save progress:', e);
                }
            },
            
            load() {
                try {
                    const data = localStorage.getItem(this.key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        AppState.completed = new Set(parsed.completed || []);
                        AppState.currentStep = parsed.currentStep || {};
                        AppState.points = parsed.points || 0;
                        AppState.earnedBadges = new Set(parsed.earnedBadges || []);
                        AppState.understandingScores = parsed.understandingScores || {};
                        return true;
                    }
                } catch (e) {
                    console.warn('Could not load progress:', e);
                }
                return false;
            },
            
            clear() {
                try {
                    localStorage.removeItem(this.key);
                    AppState.completed = new Set();
                    AppState.points = 0;
                    AppState.earnedBadges = new Set();
                    AppState.understandingScores = {};
                    LESSON_CONFIG.problems.forEach(p => AppState.currentStep[p.id] = 1);
                } catch (e) {
                    console.warn('Could not clear progress:', e);
                }
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ® GAMIFICATION MANAGER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const GamificationManager = {
            addPoints(amount, reason = '') {
                if (!GAMIFICATION_CONFIG.enabled || !GAMIFICATION_CONFIG.points.enabled) return;
                
                AppState.points += amount;
                this.updatePointsDisplay();
                this.showPointsPopup(amount);
                SoundManager.playPoints();
                StorageManager.save();
            },
            
            updatePointsDisplay() {
                const el = document.getElementById('pointsValue');
                if (el) el.textContent = AppState.points;
            },
            
            showPointsPopup(amount) {
                const popup = document.createElement('div');
                popup.className = 'points-popup';
                popup.textContent = `+${amount}`;
                popup.style.left = '50%';
                popup.style.top = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 1000);
            },
            
            checkBadges() {
                if (!GAMIFICATION_CONFIG.enabled || !GAMIFICATION_CONFIG.badges.enabled) return;
                
                const badges = GAMIFICATION_CONFIG.badges.list;
                const totalProblems = LESSON_CONFIG.problems.length;
                const completedProblems = AppState.completed.size;
                
                badges.forEach(badge => {
                    if (AppState.earnedBadges.has(badge.id)) return;
                    
                    let earned = false;
                    
                    switch (badge.condition) {
                        case 'complete_first_step':
                            earned = Object.values(AppState.currentStep).some(s => s > 1);
                            break;
                        case 'complete_first_problem':
                            earned = completedProblems >= 1;
                            break;
                        case 'complete_3_problems':
                            earned = completedProblems >= 3;
                            break;
                        case 'complete_all':
                            earned = completedProblems === totalProblems;
                            break;
                        case 'complete_under_2min':
                            const elapsed = (Date.now() - AppState.startTime) / 1000;
                            earned = completedProblems >= 1 && elapsed < 120;
                            break;
                        case 'all_high_understanding':
                            const scores = Object.values(AppState.understandingScores);
                            earned = scores.length >= 1 && scores.every(s => s >= 4);
                            break;
                    }
                    
                    if (earned) {
                        this.awardBadge(badge);
                    }
                });
            },
            
            awardBadge(badge) {
                AppState.earnedBadges.add(badge.id);
                this.addPoints(badge.points, `Badge: ${badge.name}`);
                this.displayBadge(badge);
                SoundManager.playBadge();
                StorageManager.save();
            },
            
            displayBadge(badge) {
                const container = document.getElementById('badgesContainer');
                if (!container) return;
                
                const badgeEl = document.createElement('div');
                badgeEl.className = 'badge-item';
                badgeEl.textContent = `${badge.emoji} ${badge.name}`;
                container.appendChild(badgeEl);
                
                setTimeout(() => badgeEl.classList.add('earned'), 50);
            },
            
            restoreBadges() {
                const container = document.getElementById('badgesContainer');
                if (!container) return;
                
                GAMIFICATION_CONFIG.badges.list.forEach(badge => {
                    if (AppState.earnedBadges.has(badge.id)) {
                        const badgeEl = document.createElement('div');
                        badgeEl.className = 'badge-item earned';
                        badgeEl.textContent = `${badge.emoji} ${badge.name}`;
                        container.appendChild(badgeEl);
                    }
                });
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â±ï¸ TIMER MANAGER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const TimerManager = {
            interval: null,
            
            start() {
                if (!GAMIFICATION_CONFIG.timer.enabled) {
                    document.getElementById('timerDisplay').style.display = 'none';
                    return;
                }
                
                this.interval = setInterval(() => this.update(), 1000);
            },
            
            update() {
                const elapsed = Math.floor((Date.now() - AppState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                
                const el = document.getElementById('timerValue');
                if (el) el.textContent = `${minutes}:${seconds}`;
            },
            
            stop() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“Š PROGRESS MANAGER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const ProgressManager = {
            update() {
                const totalProblems = LESSON_CONFIG.problems.length;
                const completedProblems = AppState.completed.size;
                const percentage = Math.round((completedProblems / totalProblems) * 100);
                
                // Update fixed progress bar
                const fill = document.getElementById('fixedProgressFill');
                const percent = document.getElementById('fixedProgressPercent');
                const steps = document.getElementById('fixedProgressSteps');
                const progressBar = document.getElementById('fixedProgress');
                
                if (fill) fill.style.width = `${percentage}%`;
                if (percent) percent.textContent = `${percentage}%`;
                if (steps) steps.textContent = `(${completedProblems}/${totalProblems})`;
                if (progressBar) progressBar.setAttribute('aria-valuenow', percentage);
                
                // Update inline progress bar
                const inlineFill = document.getElementById('progress');
                if (inlineFill) {
                    inlineFill.style.width = `${percentage}%`;
                    inlineFill.textContent = `${percentage}%`;
                }
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¨ VARIABLE COLOR-CODING
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        function colorCodeFormula(text) {
            if (!text) return '';
            
            let result = text;
            
            // ğŸ¨ STEP 1: Apply highlight markers Â«textÂ» â†’ golden highlight
            result = result.replace(/Â«([^Â»]+)Â»/g, 
                '<span class="highlight-step">$1</span>'
            );
            
            // ğŸ¨ STEP 2: Apply variable colors if enabled
            if (VARIABLE_COLORS.enabled) {
                Object.entries(VARIABLE_COLORS.scheme).forEach(([variable, config]) => {
                    // Don't color variables inside highlight spans
                    const regex = new RegExp(`(?<!<[^>]*)\\b(${variable})(?=\\d|Â²|Â³|â´|\\b)`, 'g');
                    result = result.replace(regex, 
                        `<span class="var-colored" style="color: ${config.color}; background: ${config.bg}; padding: 1px 3px; border-radius: 3px;">$1</span>`
                    );
                });
            }
            
            return result;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¨ THEME MANAGER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        const ThemeManager = {
            init() {
                // Check saved preference
                const saved = localStorage.getItem('icsa_theme');
                if (saved) {
                    this.setTheme(saved);
                } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    this.setTheme('dark');
                }
            },
            
            toggle() {
                const newTheme = AppState.theme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
            },
            
            setTheme(theme) {
                AppState.theme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('icsa_theme', theme);
                
                const btn = document.getElementById('themeToggle');
                if (btn) btn.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        };
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“ RENDER FUNCTIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        function renderSchoolCard() {
            const s = SCHOOL_CONFIG;
            if (!s.showCard) return '';
            
            // Programs/Services HTML
            let programsHTML = s.programs.map(p => `
                <div class="service-card">
                    <div class="service-icon">${p.icon}</div>
                    <div class="service-title">${p.title}</div>
                    <div class="service-desc">${p.description}</div>
                    <div class="service-details">${p.details}</div>
                </div>
            `).join('');
            
            // Features HTML
            let featuresHTML = s.features.map(f => `<span class="feature-tag">${f}</span>`).join('');
            
            // Show developer contact in demo version, school contact in customized version
            const contactInfo = s.isDemoVersion ? s.developer : s;
            const contactLabel = s.isDemoVersion ? "To Purchase This Template" : "Contact Us";
            const avatarEmoji = s.isDemoVersion ? "ğŸ‘¨â€ğŸ’»" : "ğŸ«";
            
            return `
                <div class="teacher-card">
                    <div class="teacher-header">
                        <div class="teacher-avatar" style="font-size: 3rem;">${avatarEmoji}</div>
                        <div class="teacher-name">${s.isDemoVersion ? contactInfo.name : s.name}</div>
                        <div class="teacher-title">${s.isDemoVersion ? contactInfo.title : s.slogan}</div>
                        <div class="teacher-badge">ğŸ† ${s.isDemoVersion ? contactInfo.experience : s.established}</div>
                    </div>
                    
                    ${s.isDemoVersion ? `
                    <div class="demo-notice" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 12px; margin: 10px 15px; border-radius: 8px; border-left: 4px solid #ff9800; text-align: center;">
                        <div style="font-weight: bold; color: #e65100; margin-bottom: 5px;">ğŸ›’ DEMO VERSION</div>
                        <div style="font-size: 0.85rem; color: #666;">This template will be customized with YOUR school's branding</div>
                    </div>
                    ` : ''}
                    
                    <div class="teacher-contact">
                        <a href="tel:${contactInfo.phone}" class="contact-phone">
                            <div><span class="phone-icon">ğŸ“±</span></div>
                            <div>
                                <div class="phone-number">${contactInfo.phone}</div>
                                <div class="phone-label">${contactLabel}</div>
                            </div>
                        </a>
                        ${s.isDemoVersion && contactInfo.whatsapp ? `
                        <a href="https://wa.me/971${contactInfo.whatsapp.replace(/^0/, '')}" class="contact-phone" style="background: #25D366; color: white; margin-top: 8px;">
                            <div><span class="phone-icon">ğŸ’¬</span></div>
                            <div>
                                <div class="phone-number" style="color: white;">WhatsApp</div>
                                <div class="phone-label" style="color: rgba(255,255,255,0.9);">Quick Response</div>
                            </div>
                        </a>
                        ` : ''}
                    </div>
                    
                    <div class="teacher-services">${programsHTML}</div>
                    <div class="teacher-features">${featuresHTML}</div>
                    
                    <div class="teacher-footer">
                        <div class="teacher-cta">ğŸ“ ${contactInfo.location} ${s.isDemoVersion ? '| Available for Schools Worldwide' : ''}</div>
                        <div class="powered-by">Powered by <span>ICSA Framework v3.3</span></div>
                    </div>
                </div>
            `;
        }
        
        function renderUnderstandingCheck(problemId) {
            if (!UNDERSTANDING_CONFIG.enabled) return '';
            
            const options = UNDERSTANDING_CONFIG.options.map(opt => `
                <button class="check-option" data-value="${opt.value}" data-problem="${problemId}"
                        onclick="recordUnderstanding(${problemId}, ${opt.value})"
                        style="--option-color: ${opt.color}">
                    ${opt.emoji} ${opt.label}
                </button>
            `).join('');
            
            return `
                <div class="understanding-check" id="understanding-${problemId}" style="display: none;">
                    <div class="check-question">How well did you understand this problem?</div>
                    <div class="check-options">${options}</div>
                </div>
            `;
        }
        
        function renderLesson() {
            const app = document.getElementById('app');
            const c = LESSON_CONFIG;
            
            // ğŸŒ Auto-detect and set language direction
            const lang = c.lesson.language || 'en';
            const isRTL = (lang === 'ar');
            document.documentElement.lang = lang;
            document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
            
            // Update body font for Arabic
            if (isRTL) {
                document.body.style.fontFamily = "'Tajawal', 'Segoe UI', sans-serif";
            }
            
            let html = `
                ${SCHOOL_CONFIG.showCard && SCHOOL_CONFIG.cardPosition !== 'bottom' ? renderSchoolCard() : ''}
                
                <h1>ğŸ“š ${c.lesson.topic}</h1>
                <div class="subtitle">${c.lesson.grade} - ${c.lesson.subject}</div>
                <div class="info-box">
                    <strong>${c.institution.name}</strong><br>
                    ${c.institution.location}
                </div>
                
                <section class="welcome-section" aria-labelledby="welcome-title">
                    <h2 id="welcome-title">${c.text.welcome.title}</h2>
                    <p>${c.text.welcome.description.replace('{topic}', c.lesson.topic)}</p>
                    <div class="color-guide">
                        <div class="color-item"><div class="color-dot blue"></div><div><strong>ğŸ”µ Blue</strong><small>Foundation</small></div></div>
                        <div class="color-item"><div class="color-dot green"></div><div><strong>ğŸŸ¢ Green</strong><small>Building</small></div></div>
                        <div class="color-item"><div class="color-dot orange"></div><div><strong>ğŸŸ  Orange</strong><small>Challenge</small></div></div>
                        <div class="color-item"><div class="color-dot pink"></div><div><strong>ğŸ”´ Pink</strong><small>Mastery</small></div></div>
                    </div>
                </section>
                
                <section class="progress-section" aria-labelledby="progress-title">
                    <h3 id="progress-title">${c.text.progress.title}</h3>
                    <p>${c.text.progress.description.replace('{problemCount}', c.problems.length)}</p>
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-fill" id="progress">0%</div>
                    </div>
                    <button class="btn-reset-all" onclick="resetAll()">
                        ğŸ”„ Reset All Progress
                    </button>
                </section>
                
                <section class="intro-section" aria-labelledby="intro-title">
                    <h2 id="intro-title">${c.methodIntro.title}</h2>
                    <div class="rules-box">
                        <h3>${c.methodIntro.explanation.title}</h3>
                        <p>${c.methodIntro.explanation.description}</p>
                        <div class="math-container">
                            <div class="math-line">${colorCodeFormula(c.methodIntro.explanation.formula.standard)}</div>
                        </div>
                        <p style="margin-top: 1rem; font-style: italic;">${c.methodIntro.explanation.formula.where}</p>
                    </div>
                    ${c.methodIntro.keyPoints.map(p => `
                        <div class="key-rule"><strong>ğŸ”‘ ${p.title}:</strong><p>${p.content}</p></div>
                    `).join('')}
                </section>
            `;
            
            // Problems
            c.problems.forEach(prob => {
                html += `
                    <article class="problem-card" aria-labelledby="problem-${prob.id}-title">
                        <span class="problem-num" id="problem-${prob.id}-title">${prob.label}</span>
                        <div class="equation-container">
                            <div class="equation">${colorCodeFormula(prob.equation)}</div>
                        </div>
                        <div class="controls">
                            <button class="btn btn-step" onclick="showNextStep(${prob.id})" aria-label="Show next step">
                                ${c.text.buttons.nextStep}
                            </button>
                            <button class="btn btn-all" onclick="showAll(${prob.id})" aria-label="Show all steps">
                                ${c.text.buttons.showAll}
                            </button>
                            <button class="btn btn-reset" onclick="resetProblem(${prob.id})" aria-label="Reset problem">
                                ${c.text.buttons.reset}
                            </button>
                        </div>
                        <div id="steps-${prob.id}" role="list">
                `;
                
                prob.steps.forEach(s => {
                    // Use class 'visible' only, not inline styles - v3.1 fix
                    const isVisible = AppState.completed.has(prob.id) || (AppState.currentStep[prob.id] && AppState.currentStep[prob.id] > s.number);
                    html += `
                        <div class="step ${s.level} ${isVisible ? 'visible' : ''}" id="s-${prob.id}-${s.number}" role="listitem">
                            <span class="step-number" aria-hidden="true">${s.number}</span>
                            <span class="step-title">${s.title}</span>
                            <div class="step-content">
                                ${s.content.text ? `<p>${s.content.text}</p>` : ''}
                    `;
                    
                    if (s.content.formulas && s.content.formulas.length > 0) {
                        html += `<div class="math-container">`;
                        s.content.formulas.forEach(f => {
                            if (f.trim() !== '') {
                                html += `<div class="math-line">${colorCodeFormula(f)}</div>`;
                            }
                        });
                        html += `</div>`;
                    }
                    
                    if (s.content.formula) {
                        html += `<div class="math-container"><div class="math-line">${colorCodeFormula(s.content.formula)}</div></div>`;
                    }
                    
                    html += `
                                ${s.content.visual ? `<div class="visual-aid">${s.content.visual}</div>` : ''}
                                ${s.content.hint ? `<div class="hint" role="note">ğŸ’¡ ${s.content.hint}</div>` : ''}
                                ${s.content.warning ? `<div class="warning" role="alert">âš ï¸ ${s.content.warning}</div>` : ''}
                                ${s.number < prob.steps.length ? `<button class="next-step-btn" onclick="showStep(${prob.id}, ${s.number + 1})">${c.text.buttons.nextStep}</button>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <div class="final-answer" id="final-${prob.id}" ${AppState.completed.has(prob.id) ? 'style="display: block;"' : ''}>
                            âœ… <strong>Final Answer:</strong>
                            <span class="answer-value">${colorCodeFormula(prob.finalAnswer)}</span>
                        </div>
                        ${renderUnderstandingCheck(prob.id)}
                    </div>
                    ${prob.practice ? `<div class="practice">
                        <p class="practice-title">${c.text.buttons.tryThis}</p>
                        <p>${colorCodeFormula(prob.practice)}</p>
                    </div>` : ''}
                </article>
                `;
            });
            
            html += `
                <section class="completion-section" aria-labelledby="completion-title">
                    <h2 id="completion-title">${c.text.completion.title}</h2>
                    <p>${c.text.completion.message.replace('{topic}', c.lesson.topic)}</p>
                    <p>${c.text.completion.nextSteps}</p>
                </section>
                ${SCHOOL_CONFIG.showCard && (SCHOOL_CONFIG.cardPosition === 'bottom' || SCHOOL_CONFIG.cardPosition === 'both') ? renderSchoolCard() : ''}
            `;
            
            app.innerHTML = html;
            
            // Restore visible steps if progress was loaded
            restoreVisibleSteps();
        }
        
        function restoreVisibleSteps() {
            LESSON_CONFIG.problems.forEach(prob => {
                const currentStep = AppState.currentStep[prob.id] || 1;
                for (let i = 1; i < currentStep; i++) {
                    const el = document.getElementById(`s-${prob.id}-${i}`);
                    if (el) el.classList.add('visible');
                }
                
                if (AppState.completed.has(prob.id)) {
                    const finalEl = document.getElementById(`final-${prob.id}`);
                    if (finalEl) finalEl.style.display = 'block';
                }
            });
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¯ INTERACTION FUNCTIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        function showStep(probId, stepNum) {
            const el = document.getElementById(`s-${probId}-${stepNum}`);
            if (el && !el.classList.contains('visible')) {
                el.classList.add('visible');
                AppState.currentStep[probId] = stepNum + 1;
                
                SoundManager.playStepComplete();
                GamificationManager.addPoints(GAMIFICATION_CONFIG.points.values.completeStep);
                GamificationManager.checkBadges();
                
                setTimeout(() => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                
                checkComplete(probId);
                ProgressManager.update();
                StorageManager.save();
            }
        }
        
        // ğŸ†• Dynamic next step function - v3.1
        function showNextStep(probId) {
            const prob = LESSON_CONFIG.problems.find(p => p.id === probId);
            if (!prob) return;
            
            // Find the first non-visible step
            for (let i = 1; i <= prob.steps.length; i++) {
                const el = document.getElementById(`s-${probId}-${i}`);
                if (el && !el.classList.contains('visible')) {
                    showStep(probId, i);
                    return;
                }
            }
            
            // All steps visible - mark as complete
            checkComplete(probId);
        }
        
        function showAll(probId) {
            const steps = document.querySelectorAll(`#steps-${probId} .step`);
            const delay = LESSON_CONFIG.settings?.animation?.stepDelay || 150;
            
            steps.forEach((s, i) => {
                setTimeout(() => {
                    if (!s.classList.contains('visible')) {
                        s.classList.add('visible');
                        GamificationManager.addPoints(GAMIFICATION_CONFIG.points.values.viewStep);
                    }
                }, i * delay);
            });
            
            setTimeout(() => {
                checkComplete(probId);
                ProgressManager.update();
                StorageManager.save();
            }, steps.length * delay);
        }
        
        function resetProblem(probId) {
            SoundManager.playReset();
            
            // Remove visible class AND inline display style
            document.querySelectorAll(`#steps-${probId} .step`).forEach(s => {
                s.classList.remove('visible');
                s.style.display = '';  // Remove inline style
            });
            
            const finalEl = document.getElementById(`final-${probId}`);
            if (finalEl) finalEl.style.display = 'none';
            
            const understandingEl = document.getElementById(`understanding-${probId}`);
            if (understandingEl) understandingEl.style.display = 'none';
            
            AppState.currentStep[probId] = 1;
            AppState.completed.delete(probId);
            delete AppState.understandingScores[probId];
            
            ProgressManager.update();
            StorageManager.save();
        }
        
        // ğŸ”„ Reset All Progress - v3.1
        function resetAll() {
            if (!confirm('Reset all progress? This will clear all saved data.')) return;
            
            SoundManager.playReset();
            StorageManager.clear();
            
            // Reset all problems visually
            LESSON_CONFIG.problems.forEach(prob => {
                document.querySelectorAll(`#steps-${prob.id} .step`).forEach(s => {
                    s.classList.remove('visible');
                    s.style.display = '';
                });
                
                const finalEl = document.getElementById(`final-${prob.id}`);
                if (finalEl) finalEl.style.display = 'none';
                
                const understandingEl = document.getElementById(`understanding-${prob.id}`);
                if (understandingEl) understandingEl.style.display = 'none';
            });
            
            // Reset points display
            GamificationManager.updatePointsDisplay();
            ProgressManager.update();
            
            // Show confirmation
            const msg = document.createElement('div');
            msg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#4CAF50;color:white;padding:1rem 2rem;border-radius:10px;z-index:10000;font-weight:bold;';
            msg.textContent = 'âœ… All progress reset!';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }
        
        function checkComplete(probId) {
            const prob = LESSON_CONFIG.problems.find(p => p.id === probId);
            if (!prob) return;
            
            const all = document.querySelectorAll(`#steps-${probId} .step`);
            const visible = document.querySelectorAll(`#steps-${probId} .step.visible`);
            
            if (all.length === visible.length && !AppState.completed.has(probId)) {
                AppState.completed.add(probId);
                
                // Show final answer
                const finalEl = document.getElementById(`final-${probId}`);
                if (finalEl) finalEl.style.display = 'block';
                
                // Show understanding check
                const understandingEl = document.getElementById(`understanding-${probId}`);
                if (understandingEl) understandingEl.style.display = 'block';
                
                SoundManager.playSuccess();
                GamificationManager.addPoints(GAMIFICATION_CONFIG.points.values.completeProblem);
                GamificationManager.checkBadges();
                
                if (LESSON_CONFIG.settings?.confetti?.enabled !== false) {
                    confetti();
                }
                
                // Show encouragement message
                showEncouragement('problem');
            }
        }
        
        function recordUnderstanding(probId, value) {
            AppState.understandingScores[probId] = value;
            
            // Visual feedback
            const options = document.querySelectorAll(`#understanding-${probId} .check-option`);
            options.forEach(opt => {
                opt.classList.remove('selected');
                if (parseInt(opt.dataset.value) === value) {
                    opt.classList.add('selected');
                }
            });
            
            // Award points based on understanding
            if (value >= 4) {
                GamificationManager.addPoints(GAMIFICATION_CONFIG.points.values.understandingHigh);
            } else if (value >= 3) {
                GamificationManager.addPoints(GAMIFICATION_CONFIG.points.values.understandingMedium);
            }
            
            GamificationManager.checkBadges();
            StorageManager.save();
        }
        
        function showEncouragement(type) {
            const messages = GAMIFICATION_CONFIG.celebrations.messages[type];
            if (!messages || messages.length === 0) return;
            
            const message = messages[Math.floor(Math.random() * messages.length)];
            
            const el = document.createElement('div');
            el.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4caf50, #2e7d32);
                color: white;
                padding: 1rem 2rem;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: 600;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: messagePopIn 0.5s ease;
            `;
            el.textContent = message;
            document.body.appendChild(el);
            
            setTimeout(() => el.remove(), 2000);
        }
        
        function confetti() {
            const colors = ['#2196F3', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0'];
            const count = LESSON_CONFIG.settings?.confetti?.particleCount || 50;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.style.cssText = `
                        position: fixed;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        left: ${Math.random() * window.innerWidth}px;
                        top: -20px;
                        border-radius: 50%;
                        z-index: 9999;
                        pointer-events: none;
                    `;
                    document.body.appendChild(c);
                    
                    c.animate([
                        { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                        { transform: `translateY(${window.innerHeight}px) rotate(360deg)`, opacity: 0 }
                    ], {
                        duration: 2000 + Math.random() * 1000,
                        easing: 'ease-out'
                    });
                    
                    setTimeout(() => c.remove(), 3500);
                }, i * 30);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”§ UI CONTROLS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        function createSoundToggle() {
            if (!SOUND_CONFIG.showToggleButton) return;
            
            const btn = document.createElement('button');
            btn.className = 'sound-toggle';
            btn.id = 'soundToggle';
            btn.innerHTML = 'ğŸ”Š';
            btn.title = 'Toggle Sound';
            btn.setAttribute('aria-label', 'Toggle sound');
            
            btn.addEventListener('click', () => {
                const isEnabled = SoundManager.toggle();
                btn.innerHTML = isEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                btn.classList.toggle('muted', !isEnabled);
                if (isEnabled) SoundManager.playClick();
            });
            
            document.body.appendChild(btn);
        }
        
        function createThemeToggle() {
            const btn = document.createElement('button');
            btn.className = 'theme-toggle';
            btn.id = 'themeToggle';
            btn.innerHTML = AppState.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            btn.title = 'Toggle Theme';
            btn.setAttribute('aria-label', 'Toggle dark mode');
            
            btn.addEventListener('click', () => {
                ThemeManager.toggle();
                SoundManager.playClick();
            });
            
            document.body.appendChild(btn);
        }
        
        function setupButtonSounds() {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn') || e.target.classList.contains('next-step-btn')) {
                    SoundManager.playClick();
                }
            });
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                setTimeout(() => overlay.remove(), 500);
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸš€ INITIALIZATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        window.addEventListener('load', () => {
            // Initialize theme
            ThemeManager.init();
            
            // Initialize sound
            SoundManager.init();
            
            // Load saved progress
            const hasProgress = StorageManager.load();
            
            // Create UI controls
            createSoundToggle();
            createThemeToggle();
            setupButtonSounds();
            
            // Render lesson
            renderLesson();
            
            // Update displays
            GamificationManager.updatePointsDisplay();
            GamificationManager.restoreBadges();
            ProgressManager.update();
            
            // Start timer
            TimerManager.start();
            
            // Hide loading
            setTimeout(hideLoading, 500);
            
            // Show welcome back message if progress was loaded
            if (hasProgress && AppState.points > 0) {
                setTimeout(() => {
                    showEncouragement('step');
                }, 1000);
            }
        });
        
        // Save on page unload
        window.addEventListener('beforeunload', () => {
            StorageManager.save();
        });
    </script>
</body>
</html>
